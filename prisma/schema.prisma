// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// ENUMS
// ========================================

// ========================================
// ROLES & PROFILES (One Auth to rule them all)
// ========================================

enum AppRole {
  GLOBAL_ADMIN
  TENANT_ADMIN
  USER
  B2C_CUSTOMER
}

enum InviteStatus {
  PENDING
  ACCEPTED
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum OrderStatus {
  PENDING
  READY
  PICKED_UP
  CANCELLED
}

enum SubscriptionType {
  NORMAL_12
  NORMAL_6
  NORMAL_12_BUILDUP
  NORMAL_6_BUILDUP
  INTENSE_12
  INTENSE_6
  WIN_12
  WIN_6
  WIN_12_BUILDUP
  WIN_6_BUILDUP
}

model Profile {
  id          String   @id @db.Uuid // Matches Supabase Auth User ID
  email       String   @unique
  firstName   String?
  lastName    String?
  phone       String?  // Added for B2C
  
  role        AppRole  @default(B2C_CUSTOMER)
  
  // Security / Admin
  isActive    Boolean  @default(true)
  emailNotifications Boolean @default(true)

  // Invite System
  inviteToken String?  @unique
  inviteStatus InviteStatus @default(PENDING)

  // Password Reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  
  // B2C Specifics (Nullable)
  credits     Int      @default(0)
  careLevel   Int      @default(2)
  isOffline   Boolean  @default(false)
  subscriptionType      SubscriptionType?
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  notes       String?

  // Tenant Relation (Optional for Global Admin / B2C)
  tenantId    String?  @db.Uuid
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  bookings    Booking[]
  orders      Order[]
  contentProgress UserContentProgress[]

  @@map("profiles")
}

// ========================================
// TENANT (B2B Firma)
// ========================================

enum QuotaType {
  NORMAL
  SPECIAL
}

model Tenant {
  id              String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quotaType       QuotaType @default(NORMAL)
  companyName     String
  logoUrl         String?
  primaryColor    String  @default("#1e3a5f") // Dark blue default
  secondaryColor  String  @default("#ffffff")
  dailyKontingent Int     @default(1) // Max simultaneous bookings per day
  isActive        Boolean @default(true)

  // Billing Info (Optional)
  billingAddress  String?
  billingZip      String?
  billingCity     String?
  billingEmail    String? // Invoice Email

  // Contact Info
  vatId           String? // Umsatzsteuer ID
  contactPhone    String?
  contactEmail    String? // General Contact Email

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profiles Profile[]

  @@map("tenants")
}

// ========================================
// TIMESLOT (Verfügbare Termine)
// ========================================

enum TimeslotType {
  NORMAL
  ANALYSIS
}

model Timeslot {
  id             String   @id @default(cuid())
  date           DateTime @db.Date
  startTime      DateTime @db.Time()
  endTime        DateTime @db.Time()
  globalCapacity Int      @default(10) // WSP total capacity for this slot (Legacy?)
  capacity_points Int?    @default(20) // Current Points System Capacity
  bookedCount    Int      @default(0) // Current bookings across all tenants
  isBlocked      Boolean  @default(false)
  type           TimeslotType @default(NORMAL)

  createdAt DateTime @default(now())

  // Relations
  bookings Booking[]

  @@unique([date, startTime])
  @@map("timeslots")
}

// ========================================
// BOOKING (Buchung)
// ========================================

model Booking {
  id                 String        @id @default(cuid())
  status             BookingStatus @default(CONFIRMED)
  cancellationReason String?
  reminderSentAt     DateTime?

  notes              String?

  // Guest Booking Fields
  guestName  String?
  guestEmail String?
  guestPhone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Snapshot of cost/points at time of booking
  care_level_snapshot Int @default(2)

  // Relations
  // Unified Relation to Profile (User or B2C)
  userId     String   @db.Uuid
  user       Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  timeslotId String
  timeslot   Timeslot @relation(fields: [timeslotId], references: [id], onDelete: Cascade)

  @@map("bookings")
}

// ========================================
// PRODUCT CATEGORIES
// ========================================

model Category {
  id          String  @id @default(cuid())
  name        String
  description String?
  imageUrl    String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products Product[]

  @@map("categories")
}


// ========================================
// PRODUCT (Für Upsells/Shop)
// ========================================

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  imageUrl    String?
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  categoryId String?
  category   Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  orderItems OrderItem[]

  @@map("products")
}

// ========================================
// ORDER (Click & Collect Bestellungen)
// ========================================

model Order {
  id          String      @id @default(cuid())
  status      OrderStatus @default(PENDING)
  pickupDate  DateTime    @db.Date
  totalAmount Decimal     @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String  @db.Uuid
  user   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  items  OrderItem[]

  @@map("orders")
}

// ========================================
// ORDER ITEM
// ========================================

model OrderItem {
  id        String  @id @default(cuid())
  quantity  Int     @default(1)
  unitPrice Decimal @db.Decimal(10, 2)

  // Relations
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

// ========================================
// SETTINGS (Globale Einstellungen)
// ========================================

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// ========================================
// BLOCKED DATES (Sperrtage)
// ========================================

model BlockedDate {
  id     String   @id @default(cuid())
  date   DateTime @unique @db.Date
  reason String?

  createdAt DateTime @default(now())

  @@map("blocked_dates")
}

// ========================================
// OPENING HOURS (Öffnungszeiten)
// ========================================

model OpeningHours {
  id        String   @id @default(cuid())
  dayOfWeek Int // 0 = Sunday, 1 = Monday, etc.
  openTime  DateTime @db.Time()
  closeTime DateTime @db.Time()
  isClosed  Boolean  @default(false)

  @@unique([dayOfWeek])
  @@map("opening_hours")

  // Relations
  breaks OpeningBreak[]
}

model OpeningBreak {
  id             String       @id @default(cuid())
  startTime      DateTime     @db.Time()
  endTime        DateTime     @db.Time()
  name           String?      // e.g. "Mittagspause"

  // Relations
  openingHoursId String
  openingHours   OpeningHours @relation(fields: [openingHoursId], references: [id], onDelete: Cascade)

  @@map("opening_breaks")
}

model AnalysisSchedule {
  id        String   @id @default(cuid())
  dayOfWeek Int      // 0 = Sunday, 1 = Monday
  startTime DateTime @db.Time() // Start of analysis window (e.g. 10:00)
  endTime   DateTime @db.Time() // End of analysis window (e.g. 11:00)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("analysis_schedules")
}

// ========================================
// CONTENT (Lern-Videos & PDFs)
// ========================================

enum ContentType {
  VIDEO
  PDF
}

model Course {
  id          String   @id @default(cuid())
  title       String
  description String?
  thumbnailUrl String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  contents    Content[]

  @@map("courses")
}

model Content {
  id          String      @id @default(cuid())
  title       String
  description String?
  type        ContentType
  url         String      // External video URL or PDF download link
  thumbnailUrl String?
  isPremium   Boolean     @default(false) // If true, maybe restrict access?
  sortOrder   Int         @default(0)
  isActive    Boolean     @default(true)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  courseId    String?
  course      Course?     @relation(fields: [courseId], references: [id], onDelete: SetNull)
  progress    UserContentProgress[]

  @@map("contents")
}

model UserContentProgress {
  id        String   @id @default(cuid())
  userId    String   @db.Uuid
  contentId String
  completed Boolean  @default(false)
  viewedAt  DateTime @default(now())

  // Relations
  user    Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@map("user_content_progress")
}

// ========================================
// KANBAN TASKS (Super Admin)
// ========================================

model KanbanTask {
  id          String    @id @default(cuid())
  title       String
  description String?
  status      String    @default("TODO") // TODO, PROGRESS, REVIEW, DONE
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  position    Int       @default(0)
  dueDate     DateTime?
  assignee    String?   // Name or Initials for simplicity (or relation if needed later)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("kanban_tasks")
}

// ========================================
// ADMIN NOTIFICATIONS (Mailbox for System Events)
// ========================================

model AdminNotification {
  id        String   @id @default(cuid())
  title     String
  message   String   @db.Text
  type      String   @default("INFO") // INFO, WARNING, CANCEL, SUCCESS
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("admin_notifications")
}
